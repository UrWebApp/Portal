<main class="container postWrap">
  <article class="postArticle">
    <div class="postArticleHeader">
      <h1 class="pt-1">套用工廠方法設計 FtpClient</h1>
      <div class="infoBox">
        <i class="fa fa-eye" aria-hidden="true"></i>
        <p class="waline-pageview-count" data-path="/Dev-Tech/CreateFtpClitentWithFactory/" />
        </p>
        <span>|</span>
        <p>2023/07/07</p>
        <span>|</span>
        <p>
          
            <a href="/categories/Dev-Tech/ ">Dev Tech </a>
            
        </p>
        <span>|</span>
        <ul class="tagBox">
          
            <li>
              <a href="/tags/Net/">
                <!-- <i class="fa-solid fa-tag"></i>  -->
                <div class="tagIcon"></div>
                .Net
              </a>
            </li>
            
        </ul>
      </div>
    </div>
    <div class="postArticleContent">
      <div class="authorsWordsBox">
        <p class="title">kai98k</p>
        <p class="content">隨著網路協定越來越多元，如果每多一種安全協定，就要為此協定，特別寫一個類別，而越來越多的類別，如果沒有介面規範，就很容易你中有我，我中有你，且無法讓我用你，你可以用我(?，也就是高耦合、低內聚，這時候就可以使用工廠方法，來重複使用單一元件，及不會改A動B。</p>
      </div>
      <h2 id="工廠方法"><a href="#工廠方法" class="headerlink" title="工廠方法"></a>工廠方法</h2><p><img src="./assets/img/download.png" data-original="https://hackmd.io/_uploads/B1-Otf8Vh.png" alt="工廠方法"></p>
<p>工廠方法（Factory Method）是一種常見的設計模式，屬於物件導向設計模式的一種。它提供了一個創建物件的介面，但具體的物件的創建是由繼承類別來實現的。工廠方法模式允許一個類別將物件的創建延遲到子類別中進行。</p>
<p>工廠方法模式的主要目的是將物件的創建與使用解耦，這樣可以在不修改現有程式碼的情況下，輕鬆地引入新的物件類別。它提供了一種靈活的方式來建立物件，並且可以根據需要在運行時決定要實例化的具體類別。</p>
<p>在工廠方法模式中，通常會有一個抽象的工廠類別，該類別定義了一個創建物件的介面，但沒有具體實現。繼承類別將根據需要實現工廠類別，並覆寫工廠方法以創建具體的物件。</p>
<h4 id="C-程式碼範例"><a href="#C-程式碼範例" class="headerlink" title="C# 程式碼範例"></a>C# 程式碼範例</h4><p>這邊範例會跟上圖有一點出入，主要是工廠有沒有需要繼承介面來實作，基本上，不同產品一定都會有介面來規範，但當工廠只有一個時，就看狀況有沒有需要介面。</p>
<ol>
<li>首先，定義抽象介面 IProduct，其中包含物件的共同操作方法：</li>
</ol>
<pre class="line-numbers language-chsarp" data-language="chsarp"><code class="language-chsarp">public interface IProduct
&#123;
    void Operation();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>接下來，實作具體的產品類別 ConcreteProductA 和 ConcreteProductB，分別實現 IProduct 介面的方法：</li>
</ol>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteProductA</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IProduct</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConcreteProductA 的操作"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteProductB</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IProduct</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConcreteProductB 的操作"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="3">
<li>接下來，定義抽象工廠介面 IFactory，其中包含創建物件的抽象方法：</li>
</ol>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFactory</span>
<span class="token punctuation">&#123;</span>
    <span class="token return-type class-name">IProduct</span> <span class="token function">CreateProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li>然後，實作具體的工廠類別 ConcreteFactoryA 和 ConcreteFactoryB，分別實現 IFactory 介面的方法：</li>
</ol>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteFactoryA</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFactory</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IProduct</span> <span class="token function">CreateProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConcreteProductA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcreteFactoryB</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFactory</span></span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IProduct</span> <span class="token function">CreateProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConcreteProductB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="5">
<li>最後，使用工廠方法模式來創建物件：</li>
</ol>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Client</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token class-name">IFactory</span> factoryA <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConcreteFactoryA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IProduct</span> productA <span class="token operator">=</span> factoryA<span class="token punctuation">.</span><span class="token function">CreateProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        productA<span class="token punctuation">.</span><span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">IFactory</span> factoryB <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConcreteFactoryB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IProduct</span> productB <span class="token operator">=</span> factoryB<span class="token punctuation">.</span><span class="token function">CreateProduct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        productB<span class="token punctuation">.</span><span class="token function">Operation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上述示例中，使用 ConcreteFactoryA 來創建 ConcreteProductA 物件，並使用 ConcreteFactoryB 來創建 ConcreteProductB 物件。這樣，根據不同的工廠類別，可以創建不同的產品物件，並調用其操作方法。</p>
<h2 id="FtpClient"><a href="#FtpClient" class="headerlink" title="FtpClient"></a>FtpClient</h2><p>接下來，就要將工廠方法套用產生不同的SFTP、FTP的 FtpClient 上，這邊會省略 FileInfo 類別的實作，普通的 Ftp&#x2F;Ftps 會引用 FluentFTP 套件，而 SFTP 則會引用 SSH.NET，但最後 Client 的操作方法都會相同。</p>
<ol>
<li>首先，創建 IFtpClient，有一共同介面來規範操作方法:<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFtpClient</span>
   <span class="token punctuation">&#123;</span>
       <span class="token return-type class-name">IFtpClient</span> <span class="token function">SetHost</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> host<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> port<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token return-type class-name"><span class="token keyword">bool</span></span> AutoDisconnect <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

       <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsConnected <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

       <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token return-type class-name">Task</span> <span class="token function">ConnectAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token return-type class-name">Task</span> <span class="token function">DisconnectAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>FileInfo<span class="token punctuation">></span></span> <span class="token function">GetListing</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IEnumerable<span class="token punctuation">&lt;</span>FileInfo<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token function">GetListingAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Download</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> localPath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> remotePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token return-type class-name">Task</span> <span class="token function">DownloadAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> localPath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> remotePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DeleteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>創建普通 FtpClient 繼承介面，並實作方法(會省略大部分實作細節)</li>
</ol>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FtpClient</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFtpClient</span></span>
   <span class="token punctuation">&#123;</span>
       <span class="token keyword">private</span> <span class="token class-name">FluentFTP<span class="token punctuation">.</span>IFtpClient</span> _client<span class="token punctuation">;</span>

       <span class="token keyword">public</span> <span class="token function">FtpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>

       <span class="token punctuation">&#125;</span>

       <span class="token keyword">public</span> <span class="token function">FtpClient</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> host<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>
           _client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FluentFTP<span class="token punctuation">.</span>FtpClient</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>

       <span class="token keyword">public</span> <span class="token function">FtpClient</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> host<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> port<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>
           _client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FluentFTP<span class="token punctuation">.</span>FtpClient</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>

       <span class="token keyword">public</span> <span class="token return-type class-name">IFtpClient</span> <span class="token function">SetHost</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> host<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> port<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>
           _client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FluentFTP<span class="token punctuation">.</span>FtpClient</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>

           <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>

       <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> AutoDisconnect <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

       <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsConnected
       <span class="token punctuation">&#123;</span>
           <span class="token keyword">get</span>
           <span class="token punctuation">&#123;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>_client <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
               <span class="token punctuation">&#123;</span>
                   <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
               <span class="token punctuation">&#125;</span>

               <span class="token keyword">return</span> _client<span class="token punctuation">.</span>IsConnected<span class="token punctuation">;</span>
           <span class="token punctuation">&#125;</span>
       <span class="token punctuation">&#125;</span>

       <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span>_client<span class="token punctuation">.</span>IsConnected<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

           _client<span class="token punctuation">.</span><span class="token function">AutoConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>
       <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_client<span class="token punctuation">.</span>IsConnected<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

           _client<span class="token punctuation">.</span><span class="token function">Disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>

       <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">DeleteFileAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>
           <span class="token keyword">try</span>
           <span class="token punctuation">&#123;</span>
               <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

               <span class="token keyword">await</span> _client<span class="token punctuation">.</span><span class="token function">DeleteFileAsync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">&#125;</span>
           <span class="token keyword">finally</span>
           <span class="token punctuation">&#123;</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span>AutoDisconnect<span class="token punctuation">)</span>
               <span class="token punctuation">&#123;</span>
                   <span class="token function">Disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token punctuation">&#125;</span>
           <span class="token punctuation">&#125;</span>
       <span class="token punctuation">&#125;</span>
       <span class="token comment">//.............</span>
      <span class="token comment">/*...省略實作...*/</span>
   <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="3">
<li>創建 SftpClient 繼承介面，並實作方法(會省略大部分實作細節):</li>
</ol>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SftpClient</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFtpClient</span></span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">Renci<span class="token punctuation">.</span>SshNet<span class="token punctuation">.</span>SftpClient</span> _client<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">SftpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>

        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token function">SftpClient</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> host<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> port<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> kauth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">KeyboardInteractiveAuthenticationMethod</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> pauth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">PasswordAuthenticationMethod</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            kauth<span class="token punctuation">.</span>AuthenticationPrompt <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventHandler<span class="token punctuation">&lt;</span>Renci<span class="token punctuation">.</span>SshNet<span class="token punctuation">.</span>Common<span class="token punctuation">.</span>AuthenticationPromptEventArgs<span class="token punctuation">></span></span><span class="token punctuation">(</span>HandleKeyEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> connectionInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConnectionInfo</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> pauth<span class="token punctuation">,</span> kauth<span class="token punctuation">)</span><span class="token punctuation">;</span>

            _client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Renci<span class="token punctuation">.</span>SshNet<span class="token punctuation">.</span>SftpClient</span><span class="token punctuation">(</span>connectionInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">HandleKeyEvent</span><span class="token punctuation">(</span><span class="token class-name">Object</span> sender<span class="token punctuation">,</span> <span class="token class-name">Renci<span class="token punctuation">.</span>SshNet<span class="token punctuation">.</span>Common<span class="token punctuation">.</span>AuthenticationPromptEventArgs</span> e<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Renci<span class="token punctuation">.</span>SshNet<span class="token punctuation">.</span>Common<span class="token punctuation">.</span>AuthenticationPrompt</span> prompt <span class="token keyword">in</span> e<span class="token punctuation">.</span>Prompts<span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prompt<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">IndexOf</span><span class="token punctuation">(</span><span class="token string">"Password:"</span><span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>InvariantCultureIgnoreCase<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token punctuation">&#123;</span>
                        prompt<span class="token punctuation">.</span>Response <span class="token operator">=</span> password<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> AutoDisconnect <span class="token punctuation">&#123;</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsConnected
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">get</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_client <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token keyword">return</span> _client<span class="token punctuation">.</span>IsConnected<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_client<span class="token punctuation">.</span>IsConnected<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>

            _client<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Download</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> localPath<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> remotePath<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">&#123;</span>
                <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>File<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span>localPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    File<span class="token punctuation">.</span><span class="token function">Delete</span><span class="token punctuation">(</span>localPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> fileStream <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>localPath<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    _client<span class="token punctuation">.</span><span class="token function">DownloadFile</span><span class="token punctuation">(</span>remotePath<span class="token punctuation">,</span> fileStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">finally</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>AutoDisconnect<span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token function">Disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DeleteFile</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> path<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">&#123;</span>
                <span class="token function">Connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                _client<span class="token punctuation">.</span><span class="token function">DeleteFile</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">finally</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>AutoDisconnect<span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    <span class="token function">Disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">/*...省略...*/</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li>創建工廠產生 Client:</li>
</ol>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FtpFactory</span>
    <span class="token punctuation">&#123;</span>

        <span class="token keyword">public</span> <span class="token function">FtpFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>

        <span class="token punctuation">&#125;</span>
        <span class="token comment">/// &lt;summary></span>
        <span class="token comment">/// use protocol to select the proper FtpClient</span>
        <span class="token comment">/// &lt;/summary></span>
        <span class="token comment">/// &lt;param name="host">IP Address&lt;/param></span>
        <span class="token comment">/// &lt;param name="port">&lt;/param></span>
        <span class="token comment">/// &lt;param name="userName">&lt;/param></span>
        <span class="token comment">/// &lt;param name="password">&lt;/param></span>
        <span class="token comment">/// &lt;param name="protocol">&lt;/param></span>
        <span class="token keyword">public</span> <span class="token return-type class-name">IFtpClient</span> <span class="token function">CreateClient</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> host<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> port<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> userName<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> password<span class="token punctuation">,</span> <span class="token class-name">FtpProtocols</span> protocol <span class="token operator">=</span> FtpProtocols<span class="token punctuation">.</span>SFTP<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol <span class="token operator">==</span> FtpProtocols<span class="token punctuation">.</span>SFTP<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SftpClient</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FtpClient</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> userName<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">FtpProtocols</span>
    <span class="token punctuation">&#123;</span>
        FTP <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        FTPS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        SFTP <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="5">
<li>使用工廠:<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token function">FtpFactoryTest</span><span class="token punctuation">(</span><span class="token class-name">IConfiguration</span> configuration<span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
          _configuration <span class="token operator">=</span> configuration<span class="token punctuation">;</span>
          <span class="token class-name"><span class="token keyword">var</span></span> _ftpIP <span class="token operator">=</span> _configuration<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"FTPInfo:IP"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name"><span class="token keyword">var</span></span> _ftpUserName <span class="token operator">=</span> _configuration<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"FTPInfo:UserName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name"><span class="token keyword">var</span></span> _ftpPassword <span class="token operator">=</span> _configuration<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"FTPInfo:Password"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name"><span class="token keyword">var</span></span> _Port <span class="token operator">=</span> _configuration<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"FTPInfo:Port"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name"><span class="token keyword">var</span></span> _Protocol <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>FtpProtocols<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"FTPInfo:Protocol"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          _ftpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FtpFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CreateClient</span><span class="token punctuation">(</span>_ftpIP<span class="token punctuation">,</span> _Port<span class="token punctuation">,</span> _ftpUserName<span class="token punctuation">,</span> _ftpPassword<span class="token punctuation">,</span> _Protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
          _fileLocation <span class="token operator">=</span> _configuration<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetValue</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"FileLocation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<p>使用工廠方法設計模式可以實現物件的靈活創建，並將物件的創建與使用解耦，同時也便於擴展和維護程式碼。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10239444">抽象工廠模式 | Abstract Factory Pattern</a></li>
</ul>

    </div>
  </article>
  <div class="postNext d-flex justify-content-between mt-3 mb-3">
    
      <h4>
        <a href="/English/IeltsNotes/">
          <span><<</span>
          <!-- <i class="fa-solid fa-angles-left"></i>  -->
          雅思筆記
        </a>
      </h4>
      
        
          <h4>
            <a href="/Dev-Tech/WrapperHighOrderComponent/">
              二次封裝實現自己的函式庫：Angular 
              <span>>></span>
              <!-- <i class="fa-solid fa-angles-right"></i> -->
            </a>
          </h4>
          
  </div>
  
  <div id="waline"></div>
  <script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
    let option = '{"el":"#waline","enable":true,"serverURL":"https://waline-urweb.vercel.app/","placeholder":"歡迎隨時提出您的建議，並不吝指教","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":"en","visitor":true,"comment_count":true,"requiredFields":["nick","mail"],"libUrl":"https://cdnjs.cloudflare.com/ajax/libs/waline/2.14.5/waline.js","pageview":true,"reaction":true}';
    init(JSON.parse(option));
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>
  
    <input style="display:none" onload="addTotalViews()">
</main>