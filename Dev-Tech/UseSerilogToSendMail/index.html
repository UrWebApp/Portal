<main class="container postWrap">
  <article class="postArticle">
    <div class="postArticleHeader">
      <h1 class="pt-1">.NET6 使用 Serilog，在 log 當下同時寄信</h1>
      <div class="infoBox">
        <i class="fa fa-eye" aria-hidden="true"></i>
        <p class="waline-pageview-count" data-path="/Dev-Tech/UseSerilogToSendMail/" />
        </p>
        <span>|</span>
        <p>2023/01/04</p>
        <span>|</span>
        <p>
          
            <a href="/categories/Dev-Tech/ ">Dev Tech </a>
            
        </p>
        <span>|</span>
        <ul class="tagBox">
          
            <li>
              <a href="/tags/Net/">
                <!-- <i class="fa-solid fa-tag"></i>  -->
                <div class="tagIcon"></div>
                .Net
              </a>
            </li>
            
            <li>
              <a href="/tags/Log/">
                <!-- <i class="fa-solid fa-tag"></i>  -->
                <div class="tagIcon"></div>
                Log
              </a>
            </li>
            
        </ul>
      </div>
    </div>
    <div class="postArticleContent">
      <div class="authorsWordsBox">
        <p class="title">kai98k</p>
        <p class="content">這個作者很懶，什麼都沒留下...</p>
      </div>
      <p>在專案中，上機測試常常會碰到原本開發上沒遇過的問題，這時候就要環境中留存的 Log 來做 Debug 了。除此之外，當特定的事件發生時，除了要 Log 下來，還要寄信給相關人員時，就可以嘗試使用 Serilog。</p>
<p>如果沒有複雜的 Log 需求時，我推薦使用輕量&#x2F;視覺化的 WatchDog 來做 log 輔助。</p>
<h2 id="安裝步驟"><a href="#安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟</h2><p>可以在 Nuget 介面安裝或是下指令</p>
<pre class="line-numbers language-PowerShell" data-language="PowerShell"><code class="language-PowerShell">dotnet add package Serilog.AspNetCore &#x2F;&#x2F; 套件包
dotnet add package Serilog.Sinks.Email &#x2F;&#x2F;輸出至Email<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>因為主要是需要在事件發生時紀錄並寄信，所以只安裝相關 Email 套件，如有其他需求時，可以在 Nuget 介面查詢相關字眼</p>
<pre class="line-numbers language-PowerShell" data-language="PowerShell"><code class="language-PowerShell">dotnet add package Serilog.Sinks.Debug
dotnet add package Serilog.Sinks.File
dotnet add package Serilog.Sinks.Seq
dotnet add package Serilog.Sinks.MSSqlServer
dotnet add package Serilog.Settings.Configuration
dotnet add package Serilog.Extensions.Hosting
dotnet add package Serilog.Formatting.Compact
dotnet add package Serilog.Enrichers.Environment
dotnet add package Serilog.Enrichers.Thread<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="在-Program-cs-初始化-Serilog-設定"><a href="#在-Program-cs-初始化-Serilog-設定" class="headerlink" title="在 Program.cs 初始化 Serilog 設定"></a>在 Program.cs 初始化 Serilog 設定</h2><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">Serilog</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Serilog<span class="token punctuation">.</span>Events</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Serilog<span class="token punctuation">.</span>Sinks<span class="token punctuation">.</span>Email</span><span class="token punctuation">;</span>

Log<span class="token punctuation">.</span>Logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">LoggerConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>MinimumLevel<span class="token punctuation">.</span><span class="token function">Information</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>MinimumLevel<span class="token punctuation">.</span><span class="token function">Override</span><span class="token punctuation">(</span><span class="token string">"Microsoft.AspNetCore"</span><span class="token punctuation">,</span> LogEventLevel<span class="token punctuation">.</span>Warning<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>Enrich<span class="token punctuation">.</span><span class="token function">FromLogContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Console</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Log 寫入 Console</span>
    <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">File</span><span class="token punctuation">(</span><span class="token string">"logs/log-.txt"</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">rollingInterval</span><span class="token punctuation">:</span> RollingInterval<span class="token punctuation">.</span>Day<span class="token punctuation">)</span> <span class="token comment">// Log 寫入 TXT 檔，以當日日期為檔名區分</span>
    <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Email</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">EmailConnectionInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        MailServer <span class="token operator">=</span> <span class="token string">"smtp.gmail.com"</span><span class="token punctuation">,</span>
        Port <span class="token operator">=</span> <span class="token number">465</span><span class="token punctuation">,</span>
        EnableSsl <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        NetworkCredentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NetworkCredential</span><span class="token punctuation">(</span><span class="token string">"account@gmail.com"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// SMTP 認證帳號跟密碼</span>
        EmailSubject <span class="token operator">=</span> <span class="token string">"No-reply Notification"</span><span class="token punctuation">,</span> <span class="token comment">//郵件主旨</span>
        FromEmail <span class="token operator">=</span> <span class="token string">"xxxx@gmail.com"</span><span class="token punctuation">,</span> <span class="token comment">//寄件者</span>
        ToEmail <span class="token operator">=</span> <span class="token string">"xxxx@gmail.com"</span> <span class="token comment">// 收件者</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// 其他程式碼</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     Log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"Host terminated unexpectedly"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">finally</span>
    <span class="token punctuation">&#123;</span>
    Log<span class="token punctuation">.</span><span class="token function">CloseAndFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 <code>finally</code> 中的 <code>Log.CloseAndFlush();</code>，可以讓程式在意外結束中確實寫入 log。</p>
<p>在範例程式碼可看到，可以自行決定要將 Log 寫在本地的 Txt 檔，或是透過郵件來發送，也可以存在 SQL 中(無實作)等等。</p>
<p>透過官方<a target="_blank" rel="noopener" href="https://github.com/serilog/serilog/wiki/Writing-Log-Events">Github wiki</a>可以知道 Serilog 有提供靜態類別 Log 可用在專案的任何地方，在使用之前要先設定好 Log.Logger。</p>
<h3 id="靜態類別-Log-使用方式"><a href="#靜態類別-Log-使用方式" class="headerlink" title="靜態類別 Log 使用方式"></a>靜態類別 Log 使用方式</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">Log<span class="token punctuation">.</span><span class="token function">Verbose</span><span class="token punctuation">(</span><span class="token string">"紀錄"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 詳細資訊</span>
Log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">"紀錄"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Log<span class="token punctuation">.</span><span class="token function">Information</span><span class="token punctuation">(</span><span class="token string">"紀錄"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用者層級</span>
Log<span class="token punctuation">.</span><span class="token function">Warning</span><span class="token punctuation">(</span><span class="token string">"紀錄"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"紀錄"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"紀錄"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Log-Event-Level"><a href="#Log-Event-Level" class="headerlink" title="Log Event Level"></a>Log Event Level</h3><p>另外，Serilog <a target="_blank" rel="noopener" href="https://github.com/serilog/serilog/blob/dev/src/Serilog/Events/LogEventLevel.cs">事件層級</a>有6個，分別是 <code>Verbose = 0</code>，<code> Debug = 1</code>， <code>Information = 2</code>， <code>Warning = 3</code>，<code>Error = 4</code>，<code>Fatal = 5</code>。</p>
<p>在上面的範例程式碼中的，<code>MinimumLevel</code> 是顯示的最低事件層級，預設是<code>Information</code>，可設定為<code>MinimumLevel.Debug()</code>、<code>MinimumLevel.Verbose()</code>等等，log事件會從該層級開始依序顯示。</p>
<h2 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h2><p>可以用剛剛的靜態類別 Log 來幫助測試，或者也可以故意在程式碼中來埋下錯誤實驗。</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">try</span>
  <span class="token punctuation">&#123;</span>
    Log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Host terminated unexpectedly"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"錯誤"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>過不久就可以收到郵件了，也可以在專案中看見 Log 資料夾。</p>
<p><img src="./assets/img/download.png" data-original="https://i.imgur.com/su8O8Jy.png" alt="log"></p>
<h2 id="進階用法"><a href="#進階用法" class="headerlink" title="進階用法"></a>進階用法</h2><p>因為需要動態填入收信者，所以需在 Nuget 或下指令多安裝</p>
<pre class="line-numbers language-PowerShell" data-language="PowerShell"><code class="language-PowerShell">dotnet add package Serilog.Sinks.Map &#x2F;&#x2F; 在 Config 中使用變數<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>安裝完後，剛剛在 Program.cs 的設定需要調整一下</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">Log<span class="token punctuation">.</span>Logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">LoggerConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>MinimumLevel<span class="token punctuation">.</span><span class="token function">Information</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>MinimumLevel<span class="token punctuation">.</span><span class="token function">Override</span><span class="token punctuation">(</span><span class="token string">"Microsoft.AspNetCore"</span><span class="token punctuation">,</span> LogEventLevel<span class="token punctuation">.</span>Warning<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>Enrich<span class="token punctuation">.</span><span class="token function">FromLogContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Console</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">File</span><span class="token punctuation">(</span><span class="token string">"logs/log-.txt"</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">rollingInterval</span><span class="token punctuation">:</span> RollingInterval<span class="token punctuation">.</span>Day<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">"Address"</span><span class="token punctuation">,</span> <span class="token string">"default@gmail.com"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>address<span class="token punctuation">,</span> wt<span class="token punctuation">)</span> <span class="token operator">=></span> wt<span class="token punctuation">.</span><span class="token function">Email</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">EmailConnectionInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        MailServer <span class="token operator">=</span> <span class="token string">"smtp.gmail.com"</span><span class="token punctuation">,</span>
        Port <span class="token operator">=</span> <span class="token number">465</span><span class="token punctuation">,</span>
        EnableSsl <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        NetworkCredentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NetworkCredential</span><span class="token punctuation">(</span><span class="token string">"xxxx@gmail.com"</span><span class="token punctuation">,</span> <span class="token string">"xxxx"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        EmailSubject <span class="token operator">=</span> <span class="token string">"Notification"</span><span class="token punctuation">,</span>
        FromEmail <span class="token operator">=</span> <span class="token string">"xxxx@gmail.com"</span><span class="token punctuation">,</span>
        ToEmail <span class="token operator">=</span> address<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>主要差異在於下面這段</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">"Address"</span><span class="token punctuation">,</span> <span class="token string">"default@gmail.com"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>address<span class="token punctuation">,</span> wt<span class="token punctuation">)</span> <span class="token operator">=></span> wt<span class="token punctuation">.</span><span class="token function">Email</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">EmailConnectionInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token range operator">..</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>以下皆可自行取名</p>
<ul>
<li><code>Address</code>: 可以在靜態方法 Log 中使用。</li>
<li><code>default@gmail.com</code>: 此參數為預設值，會帶進右方括弧中第一個參數。</li>
<li><code>address</code>: 可在箭頭函式使用的變數，由靜態方法 Log 的地個參數傳回。</li>
<li><code>wt</code>: 為 <code>WriteTo</code>。</li>
</ul>
<p>接著使用靜態方法 Log 時，就可以寄給不同對象。</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">try</span>
            <span class="token punctuation">&#123;</span>

                Log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 預設收件者</span>
                Log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Host terminated unexpectedly &#123;Address&#125;"</span><span class="token punctuation">,</span> <span class="token string">"test1.com.tw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">"Host terminated unexpectedly &#123;Address&#125;"</span><span class="token punctuation">,</span> <span class="token string">"test2.com.tw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"錯誤"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/serilog/serilog/wiki">Serilog</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.miniasp.com/post/2021/11/29/How-to-use-Serilog-with-NET-6">.NET 6.0 如何使用 Serilog 對應用程式事件進行結構化紀錄</a></li>
<li><a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/articles/10295821">ASP.NET Core 30 天旅程</a></li>
</ul>

    </div>
  </article>
  <div class="postNext d-flex justify-content-between mt-3 mb-3">
    
      <h4>
        <a href="/Dev-Tech/NET6LogToolWatchDog/">
          <span><<</span>
          <!-- <i class="fa-solid fa-angles-left"></i>  -->
          .NET 6 輕量視覺化 Log 工具 WatchDog
        </a>
      </h4>
      
        
  </div>
  
  <div id="waline"></div>
  <script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
    let option = '{"el":"#waline","enable":true,"serverURL":"https://waline-urweb.vercel.app/","placeholder":"歡迎隨時提出您的建議，並不吝指教","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":"en","visitor":true,"comment_count":true,"requiredFields":["nick","mail"],"libUrl":"https://cdnjs.cloudflare.com/ajax/libs/waline/2.14.5/waline.js","pageview":true,"reaction":true}';
    init(JSON.parse(option));
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>
  
    <input style="display:none" onload="addTotalViews()">
</main>