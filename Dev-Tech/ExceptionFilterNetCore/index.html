<main class="container postWrap">
  <article class="postArticle">
    <div class="postArticleHeader">
      <h1 class="pt-1">Net core 全域異常處理</h1>
      <div class="infoBox">
        <i class="fa fa-eye" aria-hidden="true"></i>
        <p class="waline-pageview-count" data-path="/Dev-Tech/ExceptionFilterNetCore/" />
        </p>
        <span>|</span>
        <p>2023/02/28</p>
        <span>|</span>
        <p>
          
            <a href="/categories/Dev-Tech/ ">Dev Tech </a>
            
        </p>
        <span>|</span>
        <ul class="tagBox">
          
            <li>
              <a href="/tags/Net/">
                <!-- <i class="fa-solid fa-tag"></i>  -->
                <div class="tagIcon"></div>
                .Net
              </a>
            </li>
            
            <li>
              <a href="/tags/Exception/">
                <!-- <i class="fa-solid fa-tag"></i>  -->
                <div class="tagIcon"></div>
                Exception
              </a>
            </li>
            
            <li>
              <a href="/tags/Filter/">
                <!-- <i class="fa-solid fa-tag"></i>  -->
                <div class="tagIcon"></div>
                Filter
              </a>
            </li>
            
        </ul>
      </div>
    </div>
    <div class="postArticleContent">
      <div class="authorsWordsBox">
        <p class="title">kai98k</p>
        <p class="content">這個作者很懶，什麼都沒留下...</p>
      </div>
      <p>在開發中除了利用 Log 套件幫助我們記下有問題或是 Error 的地方，還可以利用 .Net core 中的 Filter 來處理一些異常發生時，該做的事。</p>
<h2 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h2><p>藉由微軟提供的視圖，可以看到 Filter 有點類似管道或是過濾器的概念，在 .Net core 中程式的生命週期會先進到中介層(Middleware)，再進到這次要談的 Filter。</p>
<p><img src="./assets/img/download.png" data-original="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/filters/_static/filter-pipeline-1.png?view=aspnetcore-7.0" alt=".net pipe"></p>
<h2 id="Exception-Filter"><a href="#Exception-Filter" class="headerlink" title="Exception Filter"></a>Exception Filter</h2><p>Filter 有很多種，這次要使用到的是 Exception Filter，顧名思義，就是在異常發生時會進到的過濾器。</p>
<p><img src="./assets/img/download.png" data-original="https://images2015.cnblogs.com/blog/162090/201707/162090-20170716130815660-1249491527.png" alt="filter"></p>
<h3 id="新增-ExceptionFilter-自訂名稱-class"><a href="#新增-ExceptionFilter-自訂名稱-class" class="headerlink" title="新增 ExceptionFilter(自訂名稱) class"></a>新增 ExceptionFilter(自訂名稱) class</h3><p>繼承 <code>IAsyncExceptionFilter</code> &#x2F; <code>IExceptionFilter</code>，利用 <code>OnExceptionAsync</code> 方法來自訂異常發生時該做什麼事，在範例中選擇寄信。</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Mvc<span class="token punctuation">.</span>Filters</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> <span class="token namespace">Test<span class="token punctuation">.</span>Filter</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExceptionFilter</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IAsyncExceptionFilter</span></span>
    <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">IMailService</span> _mailService<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">ExceptionFilter</span><span class="token punctuation">(</span><span class="token class-name">IMailService</span> mailService<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            _mailService <span class="token operator">=</span> mailService<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">OnExceptionAsync</span><span class="token punctuation">(</span><span class="token class-name">ExceptionContext</span> _exceptionContext<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token comment">// 尚未處理的異常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_exceptionContext<span class="token punctuation">.</span>ExceptionHandled <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#123;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> errorMsg <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> exception <span class="token operator">=</span> _exceptionContext<span class="token punctuation">.</span>Exception<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">var</span></span> stackTrace <span class="token operator">=</span> exception<span class="token punctuation">.</span>StackTrace<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#123;</span>
                    errorMsg <span class="token operator">+=</span> <span class="token interpolation-string"><span class="token string">$@"&lt;p></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">exception<span class="token punctuation">.</span>Message</span><span class="token punctuation">&#125;</span></span><span class="token string">&lt;/p>"</span></span><span class="token punctuation">;</span>
                    exception <span class="token operator">=</span> exception<span class="token punctuation">.</span>InnerException<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                
                _exceptionContext<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ContentResult</span>
                <span class="token punctuation">&#123;</span>

                <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
                _mailService<span class="token punctuation">.</span><span class="token function">CreateMessage</span><span class="token punctuation">(</span><span class="token string">"test Error"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">errorMsg</span><span class="token punctuation">&#125;</span></span><span class="token string">,&lt;p></span><span class="token interpolation"><span class="token punctuation">&#123;</span><span class="token expression language-csharp">stackTrace</span><span class="token punctuation">&#125;</span></span><span class="token string">&lt;/p>"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _mailService<span class="token punctuation">.</span><span class="token function">SendMessage</span><span class="token punctuation">(</span><span class="token string">"test@test.com.tw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _exceptionContext<span class="token punctuation">.</span>ExceptionHandled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="在-Program-cs-註冊"><a href="#在-Program-cs-註冊" class="headerlink" title="在 Program.cs 註冊"></a>在 Program.cs 註冊</h3><pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span>config <span class="token operator">=></span>
  <span class="token punctuation">&#123;</span>
      config<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ExceptionFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>如在 Filter 中有使用到 DI 注入的 Service，可以選擇用以下方法註冊。</p>
<pre class="line-numbers language-csharp" data-language="csharp"><code class="language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMailService<span class="token punctuation">,</span> MailService<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token range operator">..</span><span class="token punctuation">.</span>

builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span>config <span class="token operator">=></span>
    <span class="token punctuation">&#123;</span>
        config<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">ExceptionFilter</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.tpisoftware.com/tpu/articleDetails/2257">ASP.NET Core 中的 Filter</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/dotnet261010/p/13193124.html">.NET Core：处理全局异常</a></li>
</ul>

    </div>
  </article>
  <div class="postNext d-flex justify-content-between mt-3 mb-3">
    
      <h4>
        <a href="/Dev-Tech/WindowsTestNetTool/">
          <span><<</span>
          <!-- <i class="fa-solid fa-angles-left"></i>  -->
          Windows 測試連線工具
        </a>
      </h4>
      
        
          <h4>
            <a href="/%E8%BD%89%E8%81%B7%E6%88%90%E9%95%B7/ShiftJobMethod/">
              適用所有行業的轉職評估法 
              <span>>></span>
              <!-- <i class="fa-solid fa-angles-right"></i> -->
            </a>
          </h4>
          
  </div>
  
  <div id="waline"></div>
  <script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
    let option = '{"el":"#waline","enable":true,"serverURL":"https://waline-urweb.vercel.app/","placeholder":"歡迎隨時提出您的建議，並不吝指教","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"lang":"en","visitor":true,"comment_count":true,"requiredFields":["nick","mail"],"libUrl":"https://cdnjs.cloudflare.com/ajax/libs/waline/2.14.5/waline.js","pageview":true,"reaction":true}';
    init(JSON.parse(option));
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>
  
    <input style="display:none" onload="addTotalViews()">
</main>